---
title: "Exploratory_Analysis_Nabila"
author: "Nabila Rahman"
date: "1/14/2022"
output: pdf_document 
---

# Import data and libraries 
```{r}
# Libraries
library(data.table)
library(devtools)
library(ggplot2)
library(scater)
library(corrplot)
workDir <- "/scratch/c.mpmnr/00_NEUROHACK"

# Import Raw LASI-DAD matrix
raw_LASIDAD <-read.table(paste0(workDir, "/H_DAD_w1a3.csv"), sep=",", header=T, row.names=1)  # Raw Data
imputed_LASIDAD <-read.table(paste0(workDir,"/processed_filled.csv"),sep=",", header = T)  # Imputed By Winnie (Cheng Wai) Lei
nNnames <- read.table(paste0(workDir,"/newColNames.txt"), header = F) # Features selected and annotated by me (Nabila Rahman)

# Import column meta data
phenoData<- data.frame(fread(paste0(workDir, "/colDesc.txt"), sep="\t"))
colnames(phenoData) <-c("wave", "variable", "label", "type")
phenoData$label <- gsub(" ", "_", phenoData$label)

```

# Processing column meta data
```{r}
mainData <- raw_LASIDAD

# Add broad category to column meta_data
phenoData$desc <- NA
phenoData$desc[1:24] <- "Demographics"
phenoData$desc[25:396] <- "Cognition"
phenoData$desc[397:560] <- "Informant Report"
phenoData$desc[561:679] <- "Health And Physical Measures"
phenoData$desc[680:696] <- "Polygenic Risk Scores"
phenoData$desc[697:722] <- "Consensus Clinical Dementia Rating"
phenoData$variable <- tolower(phenoData$variable)

# Merge 
columnNames <- c( colnames(mainData)[!colnames(mainData) %in% phenoData$variable], phenoData$variable )
columnLabels <- c( colnames(mainData)[!colnames(mainData) %in% phenoData$variable], phenoData$label )
mainData <- mainData[,match(columnNames, colnames(mainData) )]
```

# Visualise Sex and Years of Education
```{r}
educ <- mainData$raeducl 
educ[educ==1] <- "less than\nlower secondary"
educ[educ==2] <- "upper secondary\n /vocational study"
educ[educ==3] <- "tertiary\neducation"
mainData$educ <- educ
mainData$ragender[mainData$ragender==1] <- "Male"
mainData$ragender[mainData$ragender==2] <- "Female"

# Bar of Education based on Gender
data_education_gender <- data.frame(table(mainData[,c("ragender","educ")]))

plot_education_gender <- 
  ggplot(data=data_education_gender, aes(x=educ, y=Freq, fill=ragender)) +
  geom_bar(stat="identity", position=position_dodge()) + 
  xlab("") +
  ylab("Number of People") + 
  guides(fill=guide_legend(title="Sex")) + 
  ggtitle("Level of Education") + 
  theme_classic()

png(paste0(workDir, "/Figures/educ.png"), width = 1000, height=600, res=200)
print(plot_education_gender)
dev.off()

print(plot_education_gender)
```

# Visualise Sex, Years of Education and Rurality
```{r}

# Rural or not?
mainData$h1rural[mainData$h1rural==0] <- "urban community"
mainData$h1rural[mainData$h1rural==1] <- "rural village"

plotData <- data.frame(table(mainData[,c("h1rural","educ", "ragender")]))

# Convert Values to percentages 
plotData$Percentage <- NA
plotData$Percentage [plotData$h1rural=="rural village" & plotData$ragender == "Female" ] <- 100 * plotData$Freq[plotData$h1rural=="rural village" & plotData$ragender == "Female" ] / sum(plotData$Freq[plotData$h1rural=="rural village" & plotData$ragender == "Female" ]) 
plotData$Percentage [plotData$h1rural=="urban community" & plotData$ragender == "Female" ] <- 100 * plotData$Freq[plotData$h1rural=="urban community" & plotData$ragender == "Female" ] / sum(plotData$Freq[plotData$h1rural=="urban community" & plotData$ragender == "Female" ]) 
plotData$Percentage [plotData$h1rural=="rural village" & plotData$ragender == "Male" ] <- 100 * plotData$Freq[plotData$h1rural=="rural village" & plotData$ragender == "Male" ] / sum(plotData$Freq[plotData$h1rural=="rural village" & plotData$ragender == "Male" ]) 
plotData$Percentage [plotData$h1rural=="urban community" & plotData$ragender == "Male" ] <- 100 * plotData$Freq[plotData$h1rural=="urban community" & plotData$ragender == "Male" ] / sum(plotData$Freq[plotData$h1rural=="urban community" & plotData$ragender == "Male" ]) 

# Faceted Bar plot to Visualise Sex, Years of Education and Rurality
plot_education_gender_rurarlity <- 
  ggplot(data=plotData, aes(x=educ, y=Percentage, fill=h1rural)) +
  geom_bar(stat="identity", position=position_dodge()) + 
  xlab("") +
  ylab("% Individual") + 
  guides(fill=guide_legend(title="")) + 
  ggtitle("Rurality") + 
  theme_classic() + 
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  facet_wrap(plotData$ragender) 

png(paste0(workDir, "/Figures/rurality.png"), width = 1500, height=600, res=200)
print(plot_education_gender_rurarlity)
dev.off()

print(plot_education_gender_rurarlity)

```

# Pre Processing
66 Feature Selection. Incorporating imputed data. Setting caregorical variables. Scaling and normalisation.
``` {r}
rawMat <- raw_LASIDAD
imputed <- imputed_LASIDAD
imputed$prim_key <- NULL
 
# Filter for for 66 features selected (Nabila)
mat <- rawMat[,  nNnames[,1]]

# Combine imputed matrix with those present in rawMat
matching_mat_imputed <- colnames(imputed)[colnames(imputed) %in% colnames(mat)]
missing_mat_imputed <- colnames(mat)[!colnames(mat) %in% colnames(imputed) ]
imputed.filt <- cbind(mat[,missing_mat_imputed], imputed[,matching_mat_imputed])
imputed.filt <- imputed.filt[,  nNnames[,1]]
mat <- imputed.filt

# Set Column names to be descriptive for better readability
colnames(mat) <- nNnames[,2]

# Remove some repeated variables
unwanted <- c("weight_kg", "weight_base",  "height_m", "BMI_category")
mat <- mat[,!colnames(mat) %in% unwanted]

# Set categorical variables as factors
setfactor <- c("sex", "rurality", "hospitalised", "prim_key" )
for (coln in setfactor) {
  mat[,coln] <- factor(mat[,coln])
}

#Scale and normalise numerical variables
for (coln in colnames(mat)) {
  if (! class(mat[,coln]) %in% c("factor", "character") ) {
    mat[,coln] <- scale(mat[,coln])
    message("Scaling ", coln)
  }
}
scaledMat <- mat

```

# Visualise features that best explain the variance in cognitive scores
```{r}

# Identify Set of Cognitive Scores whose variance we will study
cogs <- c("orientation", "executive_function", "lang_fluency", "memory", "visuospatial", "memory_immediate_episodic", "memory_delayed_episodic", "memory_recognition", "abstract_reasoning", "attention_speed", "general_cognition_score", "hmse_score", "word_list_learning_immediate", "list_learning_delayed", "word_list_recognition", "logical_memory_recognition", "logical_memory_immediate", "logical_memory_delayed", "verbal_fluency", "csid_score", "ravens_test", "total_std_cog_score")
cogfeatures <- scaledMat[,cogs]
rownames(cogfeatures) <- scaledMat[,1]
cogfeatures <- t(cogfeatures)

# Identify Set of non Cognitive Variables whose importance will be studied to explain variance in cognitive score
pheno <-  scaledMat[,!colnames(scaledMat) %in% cogs]
rownames(pheno) <- scaledMat[,1]

# Summarized Experiment Object typically for gene expression analysis but can be applied easily no non gene data.
se <- SummarizedExperiment(assays=SimpleList(counts = cogfeatures), colData = pheno
      
) 

# Get variance explained in cognitive scores
topVars.vst <- scater::getVarianceExplained(
  se
  , exprs_values="counts"
)

# Plot explanatory Variables for Cognitive Scores
expPlot <- 
  plotExplanatoryVariables(
    topVars.vst
    , nvars_to_plot = ncol(topVars.vst)
  ) + 
  theme(legend.position = "bottom") + 
  ggtitle("Explanatory Variables for Cognitive function (ordered)")  


png(paste0(workDir, "/Figures/ExpVars.png"), width = 1300, height=1100, res=200)
print(expPlot)
dev.off()

```

# Visualise Correlation Matrix of all features
```{r}

# Everything needs to be numeric for correlation so setting factors back to numeric
setnumeric <- c("sex", "rurality", "hospitalised", "prim_key" )

for (coln in setnumeric) {
  scaledMat[,coln] <- as.numeric(as.character(scaledMat[,coln]))
}

# Cognitive scores on Y axis, other son X axis
unwanted <- c("weight_kg", "weight_base",  "height_m", "BMI_category", "consensus_inconsistencies", "hospitalised", "prim_key")
scaledMat <- scaledMat[,!colnames(scaledMat) %in% unwanted]
cogs <- c("orientation", "executive_function", "lang_fluency", "memory", "visuospatial", "memory_immediate_episodic", "memory_delayed_episodic", "memory_recognition", "abstract_reasoning", "attention_speed", "general_cognition_score", "hmse_score", "word_list_learning_immediate", "list_learning_delayed", "word_list_recognition", "logical_memory_recognition", "logical_memory_immediate", "logical_memory_delayed", "verbal_fluency", "csid_score", "ravens_test", "total_std_cog_score")
cogfeatures <- scaledMat[,c(cogs, "consensus_score_final")]
pheno <-  scaledMat[,!colnames(scaledMat) %in% cogs]

# Create a correlation matrix for each "pheno" feature against "cogs" features. 
# Also create a p-Value matrix
p <- matrix(nrow=ncol(cogfeatures), ncol=ncol(pheno))
r2 <- matrix(nrow=ncol(cogfeatures), ncol=ncol(pheno))
for (cogs in 1:ncol(cogfeatures)) {
  y <- cogfeatures[,cogs]
  for (phens in 1:ncol(pheno)) {
    x <- pheno[,phens]
    test <- cor.test(x, y)
    corRes <- test$estimate
    pVal <- test$p.value
    p[ cogs, phens]  <- pVal
    r2[cogs, phens ]  <- corRes
  }
}

# Restore feature names
rownames(p) = rownames(r2) = colnames(cogfeatures)
colnames(p) = colnames(r2) = colnames(pheno)

# Visualisation Correlation between pheno and cognitive features
corr_plot <- corrplot(r2, 
         p.mat = p, sig.level = 0.01, insig = "blank")

png(paste0(workDir, "/Figures/corrPlot.png"), width = 1300, height=1100, res=120)
print(corr_plot)
dev.off()

print(corr_plot)

```
  
  
  
  
  